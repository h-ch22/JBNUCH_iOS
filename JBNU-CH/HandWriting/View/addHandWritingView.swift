//
//  addHandWritingView.swift
//  JBNU-CH
//
//  Created by ÌïòÏ∞ΩÏßÑ on 2021/12/30.
//

import SwiftUI

struct addHandWritingView: View {
    @Environment(\.presentationMode) var presentationMode
    @State private var examName = ""
    @State private var selectedDate = Date.now
    @State private var meter = ""
    @State private var term = ""
    @State private var review = ""
    @State private var howTO = ""
    @State private var title = ""
    @State private var showAlert = false
    @State private var showOverlay = false
    @State private var showPicker = false
    @State private var alertModel : addHandWritingAlertModel?
    
    @StateObject private var helper = HandWritingHelper()
    @ObservedObject var mediaItems = PickedMediaItems()
    @EnvironmentObject var userManagement : UserManagement

    var body: some View {
        NavigationView{
            ZStack {
                Color.background.edgesIgnoringSafeArea(.all)
                
                ScrollView{
                    VStack{
                        Group{
                            HStack{
                                Text("üìù Í≤åÏãúÍ∏Ä Ï†úÎ™©")
                                    .fontWeight(.semibold)
                                
                                Spacer()
                            }
                            
                            TextField("Í≤åÏãúÍ∏Ä Ï†úÎ™©", text : $title)
                                .padding(20)
                                .padding([.horizontal], 20)
                                .background(
                                    RoundedRectangle(cornerRadius: 30)
                                        .foregroundColor(.btnColor)
                                        .shadow(radius: 5)
                                        .padding([.horizontal],15)
                                )
                            
                            Spacer().frame(height : 20)
                            
                            Divider()
                            
                            Spacer().frame(height : 20)
                            
                            HStack{
                                Text("‚úèÔ∏è ÏãúÌóò Ïù¥Î¶Ñ")
                                    .fontWeight(.semibold)
                                
                                Spacer()
                            }
                            
                            TextField("ÏãúÌóò Ïù¥Î¶Ñ", text : $examName)
                                .padding(20)
                                .padding([.horizontal], 20)
                                .background(
                                    RoundedRectangle(cornerRadius: 30)
                                        .foregroundColor(.btnColor)
                                        .shadow(radius: 5)
                                        .padding([.horizontal],15)
                                )
                            
                            Spacer().frame(height : 20)
                            
                            Divider()
                            
                            Spacer().frame(height : 20)

                        }
                        
                        Group{
                            HStack{
                                Text("üóì ÏãúÌóò ÎÇ†Ïßú")
                                    .fontWeight(.semibold)
                                
                                Spacer()
                            }
                            
                            DatePicker("ÎÇ†Ïßú ÏÑ†ÌÉù", selection : $selectedDate, in : ...Date.now, displayedComponents: .date)

                            Spacer().frame(height : 20)
                            
                            Divider()
                            
                            Spacer().frame(height : 20)
                        }
                        
                        Group{
                            HStack{
                                Text("üí≠ ÏãúÌóòÏùÑ Ï§ÄÎπÑÌïòÍ≤å Îêú Í≥ÑÍ∏∞")
                                    .fontWeight(.semibold)
                                
                                Spacer()
                            }
                            
                            TextEditor(text : $meter)
                                .background(Color.btnColor)
                                .padding().lineSpacing(5).frame(height : 150)
                                .shadow(radius : 5)

                            Spacer().frame(height : 20)
                            
                            Divider()
                            
                            Spacer().frame(height : 20)
                            
                            HStack{
                                Text("‚è∞ ÏãúÌóò Ï§ÄÎπÑ Í∏∞Í∞Ñ")
                                    .fontWeight(.semibold)
                                
                                Spacer()
                            }
                            
                            TextField("Ï§ÄÎπÑ Í∏∞Í∞Ñ", text : $term)
                                .padding(20)
                                .padding([.horizontal], 20)
                                .background(
                                    RoundedRectangle(cornerRadius: 30)
                                        .foregroundColor(.btnColor)
                                        .shadow(radius: 5)
                                        .padding([.horizontal],15)
                                )
                            
                            Spacer().frame(height : 20)
                            
                            Divider()
                            
                            Spacer().frame(height : 20)
                            

                            

                        }
                        
                        Group{
                            HStack{
                                Text("üôãüèª‚Äç‚ôÄÔ∏è ÏãúÌóòÏùÑ Î≥∏ ÌõÑÍ∏∞")
                                    .fontWeight(.semibold)
                                
                                Spacer()
                            }
                            
                            TextEditor(text : $review)
                                .background(Color.btnColor)
                                .padding().lineSpacing(5).frame(height : 150)
                                .shadow(radius : 5)

                            
                            Spacer().frame(height : 20)
                            
                            Divider()
                            
                            Spacer().frame(height : 20)
                            
                            HStack{
                                Text("üìö ÏûêÏã†ÎßåÏùò Í≥µÎ∂ÄÎ≤ï")
                                    .fontWeight(.semibold)
                                
                                Spacer()
                            }
                            
                            TextEditor(text : $howTO)
                                .background(Color.btnColor)
                                .padding().lineSpacing(5).frame(height : 150)
                                .shadow(radius : 5)

                            Spacer().frame(height : 20)
                            
                            Divider()
                            
                            Spacer().frame(height : 20)
                        }
                        
                        HStack{
                            Button(action : {
                                self.mediaItems.items.removeAll()
                                self.showPicker = true
                            }){
                                Image(systemName: "photo.fill.on.rectangle.fill")
                                    .resizable()
                                    .frame(width : 20, height : 20)
                                    .foregroundColor(.accent)
                            }
                            
                            if !mediaItems.items.isEmpty{
                                ScrollView(.horizontal){
                                    HStack {
                                        ForEach(mediaItems.items, id : \.self){item in
                                            ZStack(alignment : .topTrailing) {
                                                Image(uiImage : item.photo!)
                                                    .resizable()
                                                    .frame(width : 50, height : 50)
                                                    .scaledToFit()
                                                
                                                Button(action : {
                                                    let index = mediaItems.items.firstIndex(where: {$0.id == item.id})
                                                    
                                                    if index != nil{
                                                        mediaItems.items.remove(at: index!)
                                                    }
                                                }){
                                                    Image(systemName: "xmark.circle.fill")
                                                        .foregroundColor(.red)
                                                }
                                            }
                                        }
                                    }
                                }

                            }
                            

                        }

                        
                    }.padding(20)
                }.background(Color.background.edgesIgnoringSafeArea(.all))
                    .overlay(ProgressView().isHidden(!showOverlay))
                    .sheet(isPresented : $showPicker){
                        PhotoPicker(isPresented : $showPicker, mediaItems : mediaItems){didSelectItems in
                            showPicker = false
                            
                            if didSelectItems && !mediaItems.items.isEmpty{
                                
                            }
                        }
                    }
                
                    .alert(isPresented : $showAlert){
                        switch alertModel{
                        case .emptyField:
                            return Alert(title: Text("Í≥µÎ∞± ÌïÑÎìú"), message: Text("Î™®Îì† ÌïÑÎìúÎ•º Ï±ÑÏõåÏ£ºÏÑ∏Ïöî."), dismissButton: .default(Text("ÌôïÏù∏")))
                            
                        case .fail:
                            return Alert(title: Text("Ïò§Î•ò"), message: Text("ÏöîÏ≤≠ÏùÑ Ï≤òÎ¶¨ÌïòÎäî Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.\nÎÇòÏ§ëÏóê Îã§Ïãú ÏãúÎèÑÌïòÏã≠ÏãúÏò§."), dismissButton: .default(Text("ÌôïÏù∏")))
                            
                        case .success:
                            return Alert(title: Text("ÏóÖÎ°úÎìú ÏôÑÎ£å"), message: Text("Ìï©Í≤©Ïûê ÏàòÍ∏∞Í∞Ä ÏóÖÎ°úÎìúÎêòÏóàÏäµÎãàÎã§."), dismissButton: .default(Text("ÌôïÏù∏")){
                                self.presentationMode.wrappedValue.dismiss()
                            })
                            
                        case .none:
                            return Alert(title: Text(""), message: Text(""), dismissButton: .default(Text("ÌôïÏù∏")))
                        }
                    }
                    .navigationBarTitle("ÏàòÍ∏∞ ÏûëÏÑ±ÌïòÍ∏∞", displayMode : .inline)
                        .navigationBarItems(leading: Button("Îã´Í∏∞"){
                            self.presentationMode.wrappedValue.dismiss()
                        }, trailing : Button(action : {
                            if self.title == "" || meter == "" || examName == "" || review == "" || howTO == ""{
                                self.alertModel = .emptyField
                                showAlert = true
                            }
                            
                            else{
                                showOverlay = true
                                
                                var urlList : [URL] = []
                                
                                if !mediaItems.items.isEmpty{
                                    for items in mediaItems.items{
                                        urlList.append(items.url!)
                                    }
                                }
                                
                                let dateFormatter = DateFormatter()
                                dateFormatter.dateFormat = "yyyy. MM. dd. HH:mm:ss"
                                
                                helper.uploadHandWriting(data: HandWritingDataModel(date: dateFormatter.string(from: Date()),
                                                                                    examName: examName,
                                                                                    howTO: howTO,
                                                                                    meter: meter,
                                                                                    review: review,
                                                                                    term: term,
                                                                                    examDate: dateFormatter.string(from: selectedDate),
                                                                                    college: userManagement.userInfo?.college ?? "",
                                                                                    studentNo: userManagement.userInfo?.studentNo ?? "",
                                                                                    name: userManagement.userInfo?.name ?? "",
                                                                                    uid: userManagement.userInfo?.uid ?? "",
                                                                                    id: "",
                                                                                    imageIndex: self.mediaItems.items.count,
                                                                                    title: title,
                                                                                    recommend : 0), images: urlList){result in
                                    guard let result = result else{return}
                                    
                                    showOverlay = false
                                    
                                    if !result{
                                        alertModel = .fail
                                        showAlert = true
                                    }
                                    
                                    else{
                                        alertModel = .success
                                        showAlert = true
                                    }
                                }
                            }
                        }){
                            Image(systemName : "paperplane.fill")
                        })
            }
        }
    }
}
